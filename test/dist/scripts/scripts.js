"use strict";angular.module("rafteeApp",["ngCookies","ngResource","ngSanitize","ngRoute","rafteeApp.Api","rafteeApp.Session","htmlSortable","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/dashboard.html",requireLogin:!0,controller:"MainCtrl"}).when("/login",{templateUrl:"views/login.html",requireLogin:!1,controller:"LoginCtrl"}).when("/signup",{templateUrl:"views/signup.html",requireLogin:!1,controller:"SignupCtrl"}).when("/new-website",{templateUrl:"views/new-website.html",requireLogin:!1,controller:"NewWebsiteCtrl"}).when("/forgot-password",{templateUrl:"views/forgot-password.html",requireLogin:!1,controller:"ForgotPasswordCtrl"}).when("/reset-password/:rid",{templateUrl:"views/reset-password.html",requireLogin:!1,controller:"ResetPasswordCtrl"}).when("/verify-account/:vid",{templateUrl:"views/verify-account.html",requireLogin:!1,controller:"VerifyAccountCtrl"}).when("/settings",{templateUrl:"views/settings.html",requireLogin:!0,controller:"SettingsCtrl"}).when("/editor/:siteId",{templateUrl:"views/editor.html",requireLogin:!0,controller:"EditorCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$routeParams","$route","$http","Session","CookieManager",function(a,b,c,d,e,f){a.$on("$locationChangeStart",function(a,b){if(!e.getUserAuthenticated()&&f.getAuthCookieData()){console.log("sesson not authed & cookie true");var g=f.getAuthCookieData();g.email&&g.token&&(e.setUserAuthenticated(!0),d.defaults.headers.common["API-Email"]=g.email,d.defaults.headers.common["API-Token"]=g.token)}var h=b.split("#"),i="";h[1]?(i=h[1].split("/"),i=i[1]):i="dashboard","editor"===i&&(i="editor/:siteId"),"reset-password"===i&&(i="reset-password/:rid"),"verify-account"===i&&(i="verify-account/:vid"),"dashboard"===i&&(i="/"),console.log("User Authed: "+e.getUserAuthenticated()),c.routes["/"+i].requireLogin&&!e.getUserAuthenticated()&&(window.location="/#/login",a.preventDefault())})}]),angular.module("rafteeApp").controller("EditorCtrl",["$scope","$location","Domain","Page","Block",function(a,b,c){a.menuSortableOpts={handle:".fa-bars",placeholder:'<div class="block block-row menu-row-placeholder"></div>'};var d=b.url().split("/editor/")[1];a.domain=c.get({domainId:d},function(b){a.visiblePage=0,a.siteName=b.domain}),a.saveSite=function(){a.domain.published=!1,a.domain.$update({domainId:a.siteName}),console.log("save btn pressed")},a.publishSite=function(){a.domain.published=!0,a.domain.$update({domainId:a.siteName})},a.showDomainSettings=function(){console.log("show settings")},a.addPage=function(){var b={name:"Home",blocks:[{type:"raf-big-lead",uid:"52431293caf641045aec6432",menuName:"Welcome To My Site",bgType:"image",bg:"http://666a658c624a3c03a6b2-25cda059d975d2f318c03e90bcf17c40.r92.cf1.rackcdn.com/unsplash_523b2af0710a7_1.JPG",title:"This is Magical",subTitle:"A phone an iPod an internet connected device."}],uid:"524asdfasdcaf66244445aec64"};a.domain.pages.push(b)},a.addBlock=function(b){var c={type:"raf-big-lead",uid:"524cab93caf641045aec6432",menuName:"Welcome To My Site",bgType:"image",bg:"http://666a658c624a3c03a6b2-25cda059d975d2f318c03e90bcf17c40.r92.cf1.rackcdn.com/unsplash_523b2af0710a7_1.JPG",title:"This is Magical",subTitle:"A phone an iPod an internet connected device."};console.log(b),a.domain.pages[b].blocks.push(c)}}]),angular.module("rafteeApp").controller("ForgotPasswordCtrl",["$scope",function(a){a.resetLoading=!1,a.error="",a.attemptSendReset=function(){a.resetLoading=!0,a.email?a.email="":(a.error="Please Enter An Email",a.resetLoading=!1)}}]),angular.module("rafteeApp").controller("LoginCtrl",["$scope","$http","Authenticate","Session","CookieManager",function(a,b,c,d,e){a.showPword=!1,a.loginLoading=!1,a.error="",a.togglePasswordShow=function(){a.showPword=!a.showPword},a.attemptLogin=function(){if(a.loginLoading=!0,a.username&&a.password){var f=c.login(a.username,a.password);f.success(function(c){a.loginLoading=!1,a.password=null,d.setUserAuthenticated(!0),e.setAuthCookies(a.username,c.token),b.defaults.headers.common["API-Email"]=a.username,b.defaults.headers.common["API-Token"]=c.token,b.defaults.headers.common["API-Client"]="Web",window.location="/#/",event.preventDefault()}),f.error(function(b){console.log(b),a.loginLoading=!1})}else a.error="Please enter a valid email and password",a.loginLoading=!1}}]),angular.module("rafteeApp").controller("MainCtrl",["$scope","Domain",function(a,b){a.domains=b.query()}]),angular.module("rafteeApp").controller("NewWebsiteCtrl",["$scope",function(a){a.showThemes=!0,a.showPword=!1,a.themes=["Theme 1","Theme 2","Theme 3","Theme 4","Theme 5","Theme 6"],a.attemptSignup=function(){a.signupLoading=!0},a.toggleShowThemes=function(){a.showThemes=!a.showThemes},a.selectTheme=function(b){a.siteTheme=b,a.toggleShowThemes()}}]),angular.module("rafteeApp").controller("ResetPasswordCtrl",["$scope",function(a){a.error="",a.savingLoading=!1,a.attemptSavePassword=function(){a.savingLoading=!0,a.password===a.passwordConfirm?a.error="attempting to set new password":(a.error="Passwords do not match",a.savingLoading=!1)}}]),angular.module("rafteeApp").controller("SettingsCtrl",["$scope",function(a){a.user=["username"]}]),angular.module("rafteeApp").controller("SignupCtrl",["$scope","User",function(a,b){a.showPword=!1,a.attemptSignup=function(){a.signupLoading=!0,a.user=b,a.user.email=a.email,a.user.password=a.password,a.user.save(function(b){a.signupLoading=!1,console.log(b)})}}]),angular.module("rafteeApp").controller("VerifyAccountCtrl",["$scope",function(a){a.user=["username"]}]),angular.module("rafteeApp").directive("contenteditable",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){function e(){var a=b.html();c.stripBr&&"<br>"===a&&(a=""),d.$setViewValue(a)}d&&(d.$render=function(){b.html(d.$viewValue||"")},b.on("blur keyup change",function(){a.$apply(e)}),d.$render())}}}),angular.module("rafteeApp").directive("editorMenuRow",["$timeout",function(a){return{templateUrl:"/views/editor/_editor-menu-row.html",restrict:"E",replace:!0,link:function(b,c){var d=c.find("input");b.editMenuName=function(){b.block.menuNameVis=!0,a(function(){d.focus(),b.$apply()})},b.hideEditMenuName=function(){a(function(){b.block.menuNameVis=!1,b.$apply()})},d.bind("blur",function(){b.hideEditMenuName()}),d.bind("keyup",function(a){13==a.keyCode&&b.hideEditMenuName()}),b.removeBlock=function(a,c){console.log(a+" "+c),b.domain.pages[a].blocks.splice(c,1)}}}}]),angular.module("rafteeApp").directive("rafBigLead",["$timeout","Block",function(a,b){return{templateUrl:"/views/editor/_rafbiglead.html",restrict:"E",replace:!0,scope:{domainUid:"@",pageUid:"@",block:"="},link:function(c){var d;c.localBlockModel=b.get({domainId:c.domainUid,pageId:c.pageUid,blockId:c.block.uid}),c.saveBlock=function(){c.localBlockModel.menuName=c.block.menuName,c.localBlockModel.title=c.block.title,c.localBlockModel.title=c.block.subTitle,c.localBlockModel.bgType=c.block.bgType,c.localBlockModel.bg=c.block.bg,c.localBlockModel.$update({domainId:c.domainUid,pageId:c.pageUid,blockId:c.block.uid})},c.$watch("saveTimerState",function(b){b?d=a(function(){console.log("autosaving the big lead block"),c.saveBlock(),c.saveTimerState=!1},2500):a.cancel(d)}),c.$watch("block.menuName",function(a,b){c.saveTimerState=a!==b&&a?!0:!1})}}}]),angular.module("rafteeApp").directive("rafFooter",function(){return{templateUrl:"/views/editor/_raffooter.html",restrict:"E",replace:!0,link:function(a){a.saveFooter=function(){console.log("saved footer"),a.$parent.saveSite()}}}}),angular.module("rafteeApp").directive("rafForm",["Block",function(){return{templateUrl:"/views/editor/_rafform.html",restrict:"E",replace:!0,scope:{domainUid:"@",pageUid:"@",block:"="},link:function(){}}}]),angular.module("rafteeApp").directive("rafHeader",function(){return{templateUrl:"/views/editor/_rafheader.html",restrict:"E",replace:!0,link:function(a){a.saveHeader=function(){console.log("saved header"),a.$parent.saveSite()}}}}),angular.module("rafteeApp").directive("rafHorizontalContentGrid",["$timeout","Block",function(a,b){return{templateUrl:"/views/editor/_rafhorizontalcontentgrid.html",restrict:"E",replace:!0,scope:{domainUid:"@",pageUid:"@",block:"="},link:function(c){c.deleteItem=function(a){-1!==a&&c.block.grid.splice(a,1)},c.addItem=function(){var a={title:"New Item",textContent:"this is a kick ass grid",url:"http://unsplash.s3.amazonaws.com/batch%2011/berries.jpg"};c.block.grid.push(a)};var d;c.localBlockModel=b.get({domainId:c.domainUid,pageId:c.pageUid,blockId:c.block.uid}),c.saveBlock=function(){c.localBlockModel.menuName=c.block.menuName,c.localBlockModel.title=c.block.title,c.localBlockModel.bgType=c.block.bgType,c.localBlockModel.bg=c.block.bg,c.localBlockModel.grid=c.block.grid,c.localBlockModel.$update({domainId:c.domainUid,pageId:c.pageUid,blockId:c.block.uid})},c.$watch("saveTimerState",function(b){b?d=a(function(){console.log("saving the block"),c.saveBlock(),c.saveTimerState=!1},2500):(console.log("Canceling save timer"),a.cancel(d))}),c.$watch("block.menuName",function(a,b){c.saveTimerState=a!==b&&a?!0:!1})}}}]),angular.module("rafteeApp").directive("rafSlideshow",["$timeout","Block",function(a,b){return{templateUrl:"/views/editor/_rafslideshow.html",restrict:"E",replace:!0,scope:{domainUid:"@",pageUid:"@",block:"="},link:function(c){c.deleteImage=function(a){-1!==a&&c.block.images.splice(a,1)},c.addImage=function(){var a={title:"New Image",description:"this is a kick ass image",url:"http://unsplash.s3.amazonaws.com/batch%2011/berries.jpg"};c.block.images.push(a)};var d;c.localBlockModel=b.get({domainId:c.domainUid,pageId:c.pageUid,blockId:c.block.uid}),c.saveBlock=function(){c.localBlockModel.menuName=c.block.menuName,c.localBlockModel.title=c.block.title,c.localBlockModel.bgType=c.block.bgType,c.localBlockModel.bg=c.block.bg,c.localBlockModel.images=c.block.images,c.localBlockModel.$update({domainId:c.domainUid,pageId:c.pageUid,blockId:c.block.uid})},c.$watch("saveTimerState",function(b){b?d=a(function(){console.log("saving the block"),c.saveBlock(),c.saveTimerState=!1},2500):(console.log("Canceling save timer"),a.cancel(d))}),c.$watch("block.menuName",function(a,b){c.saveTimerState=a!==b&&a?!0:!1})}}}]),angular.module("rafteeApp").directive("rafVerticalContentGrid",["$timeout","Block",function(a,b){return{templateUrl:"/views/editor/_rafverticalcontentgrid.html",restrict:"E",replace:!0,scope:{domainUid:"@",pageUid:"@",block:"="},link:function(c){c.deleteItem=function(a){-1!==a&&c.block.grid.splice(a,1)},c.addItem=function(){var a={title:"New Item",textContent:"this is a kick ass grid",url:"http://unsplash.s3.amazonaws.com/batch%2011/berries.jpg"};c.block.grid.push(a)};var d;c.localBlockModel=b.get({domainId:c.domainUid,pageId:c.pageUid,blockId:c.block.uid}),c.saveBlock=function(){c.localBlockModel.menuName=c.block.menuName,c.localBlockModel.title=c.block.title,c.localBlockModel.bgType=c.block.bgType,c.localBlockModel.bg=c.block.bg,c.localBlockModel.grid=c.block.grid,c.localBlockModel.$update({domainId:c.domainUid,pageId:c.pageUid,blockId:c.block.uid})},c.$watch("saveTimerState",function(b){b?d=a(function(){console.log("saving the block"),c.saveBlock(),c.saveTimerState=!1},2500):(console.log("Canceling save timer"),a.cancel(d))}),c.$watch("block.menuName",function(a,b){c.saveTimerState=a!==b&&a?!0:!1})}}}]),angular.module("rafteeApp").directive("navbar",function(){return{templateUrl:"/views/_navbar.html",restrict:"E",replace:!0,scope:{title:"@",brandText:"@",headerurl:"@",showback:"=",showrightside:"=",notFixed:"="}}}),angular.module("rafteeApp").directive("optionsBox",["OptionBoxNodes",function(a){return{restrict:"A",link:function(b,c){a.addNode(c[0])}}}]).service("OptionBoxNodes",function(){var a=[];this.addNode=function(b){console.log(b);try{a.push(b),console.log(a),grande.bind(a)}catch(c){console.log("Grande.js & CSS Files need to be installed")}},this.removeNode=function(b){a.splice(a.indexOf(b),1),grande.bind(a)}}),angular.module("rafteeApp").directive("pageMenuRow",["$timeout",function(a){return{templateUrl:"/views/editor/_page-menu-row.html",restrict:"E",replace:!0,link:function(b,c){var d=c.find("input");b.editPage=function(){b.$parent.visiblePage===b.$index?(b.page.nameVis=!0,a(function(){d.focus(),b.$apply()})):b.$parent.visiblePage=b.$index},b.hideEditMenuName=function(){a(function(){b.page.nameVis=!1,b.$apply()})},d.bind("blur",function(){b.hideEditMenuName()}),d.bind("keyup",function(a){13==a.keyCode&&b.hideEditMenuName()}),b.removePage=function(a){b.domain.pages.splice(a,1)}}}}]),angular.module("rafteeApp").directive("siteContentMenuSize",["$timeout",function(){return{restrict:"A",link:function(a,b){var c=function(){var a=$(window).height()-243;b.css("height",a)};$(window).resize(function(){c()}),c()}}}]),angular.module("rafteeApp.Api",["ngResource"]).factory("ApiUrl",function(){return"http://api.raftee.com/v1"}).service("Authenticate",["$http","ApiUrl",function(a,b){a.defaults.useXDomain=!0,this.login=function(c,d){return a.get(b+"/login",{headers:{"API-Email":c,"API-Password":d}})}}]).factory("User",["$resource","$http","ApiUrl",function(a,b,c){return b.defaults.useXDomain=!0,a(c+"/user",{update:{method:"PUT"}})}]).factory("Domain",["$resource","$http","ApiUrl",function(a,b,c){return b.defaults.useXDomain=!0,a(c+"/domain/:domainId",{domainId:"@id"},{update:{method:"PUT",params:{domainId:"@id"}}})}]).factory("Page",["$resource","$http","ApiUrl",function(a,b,c){return b.defaults.useXDomain=!0,a(c+"/:domainId/:pageId",{domainId:"@id",pageId:"@id"},{update:{method:"PUT",params:{domainId:"@id",pageId:"@id"}}})}]).factory("Block",["$resource","$http","ApiUrl",function(a,b,c){return b.defaults.useXDomain=!0,a(c+"/domain/:domainId/:pageId/:blockId",{domainId:"@id",pageId:"@id",blockId:"@id"},{update:{method:"PUT",params:{domainId:"@id",pageId:"@id",blockId:"@id"}}})}]),angular.module("rafteeApp.Session",[]).service("Session",function(){var a=!1;this.setUserAuthenticated=function(b){a=b},this.getUserAuthenticated=function(){return a}}).service("CookieManager",function(){var a={getItem:function(a){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(a,b,c,d,e,f){if(!a||/^(?:expires|max\-age|path|domain|secure)$/i.test(a))return!1;var g="";if(c)switch(c.constructor){case Number:g=1/0===c?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+c;break;case String:g="; expires="+c;break;case Date:g="; expires="+c.toUTCString()}return document.cookie=encodeURIComponent(a)+"="+encodeURIComponent(b)+g+(e?"; domain="+e:"")+(d?"; path="+d:"")+(f?"; secure":""),!0},removeItem:function(a,b,c){return a&&this.hasItem(a)?(document.cookie=encodeURIComponent(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(c?"; domain="+c:"")+(b?"; path="+b:""),!0):!1},hasItem:function(a){return new RegExp("(?:^|;\\s*)"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)}};this.setAuthCookies=function(b,c){console.log("Attempting to Set Cookies"),console.log(b+" : "+c);try{a.setItem("Email",b,7889230),a.setItem("Token",c,7889230)}catch(d){return d}return!0},this.getAuthCookieData=function(){var b=a.getItem("Email"),c=a.getItem("Token");return b&&c?{email:b,token:c}:!1}});